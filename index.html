<!DOCTYPE html>
<html>
<head>
<title>AstroChart</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<link rel="stylesheet" href="style.css">


<body>

<div class="centered" id="login">

    <h1>AstroChart</h1>
    <input type="text" id="sheets_link" placeholder="Your Google Sheets Link / ID">
    <br>
    <select name="chartType" id="chartType">
      <option value="Best 50 Rating">Best 50</option>
      <option value="DX Rating">DX Rating</option>
      <option value="14+ Chart Constants">14+, 15 Chart Constants</option>
      <option value="14 Chart Constants">14 Chart Constants</option>
      <option value="13+ Chart Constants">13+ Chart Constants</option>
      <option value="13 Chart Constants">13 Chart Constants</option>
    </select>
    <br>
    <div id="markers">
        <div id="marker_text">
            <span class="checkbox_text">Include FC/AP Markers</span>
            <span class="checkbox_text">Include DX☆ &nbsp Markers</span>
        </div>
        <div id="marker_checkbox">
            <div id="FCAPToggle" class="checkbox checkbox_unchecked">checked</div>
            <div id="DXstarToggle" class="checkbox checkbox_unchecked">unchecked</div>
        </div>
    </div>

    <br>
    <br>
    <div id="displaybuttoncontainer">
        <div id="buttonbackground"></div>
        <button onclick="loadtsvAsText()" id="displaybutton">Display</button>
    </div>

</div>


<div class="centered" id="main">

    <div id="credentials">
        <img id="pfp">
        
        <div id="username_rating">
            <span id="username">Username</span>
            
            <div style="display:grid;">
                <img id="rating_border" src="border 15k.png" class="absoluteposition">
                <span id="ratingDisplay"></span>
                <img id="ratingdigit1" src="monospace0.png" class="absoluteposition ratingdigit">
                <img id="ratingdigit2" src="monospace0.png" class="absoluteposition ratingdigit">
                <img id="ratingdigit3" src="monospace0.png" class="absoluteposition ratingdigit">
                <img id="ratingdigit4" src="monospace0.png" class="absoluteposition ratingdigit">
                <img id="ratingdigit5" src="monospace0.png" class="absoluteposition ratingdigit">


            </div>
        </div>

        <div id="optionalImage_container">
            <img id="optionalImage" src="https://lh3.googleusercontent.com/d/1BqbSNL2RVGjwQLjCJKrh-T5cFNA7zYnP=w1000?authuser=1/view" class="absoluteposition">
        </div>

        <div id="details">
            <span id="credit">AstroChart by @LangLang</span>
            <div id="date_type">
                <span id="chartTypeDisplay">Best 50 Score</span>
                <span id="date">0/0/0</span>
            </div>
        </div>

    </div>




<div id="screen">

</div>
</div>
<div class="centered" id="back_save">
    <button onclick="back()" class="back_saveButton">Back</button>
    <button id="savebutton" class="back_saveButton">Save Chart</button>
</div>



<!--
<input type="file" id="fileToLoad" class="button">
<button onclick="loadFileAsText()" class="button">Load Selected File</button>
-->



</body>
<!--
<script src="Maimai Chart Constants.js"></script>
-->

<script type="text/javascript">

var counter = 0
var screen = document.getElementById("screen")
var totalrating = 0

var constantGroups = 
[
    ["14+",["15.0","14.9","14.8","14.7","14.6"]],
    ["14",["14.5","14.4","14.3","14.2","14.1","14.0"]],
    ["13+",["13.9","13.8","13.7","13.6"]],
    ["13",["13.5","13.4","13.3","13.2","13.1","13.0"]]
]

function generate ()
{

    //hideclass('button')

    if (ismobile())
    {
        document.getElementById("ratingDisplay").style.fontFamily = "Thicccboi"
    }
    else
    {
        document.getElementById("ratingDisplay").style.fontFamily = "monospace"
    }

    //date
    n =  new Date();
    y = n.getFullYear();
    m = n.getMonth() + 1;
    d = n.getDate();
    document.getElementById("date").innerHTML = d + "/" + m + "/" + y;


    counter = 0
    totalrating = 0
    const children = Array.from(screen.children);
    for (const child of children) {
        screen.removeChild(child);
    }


    if (document.getElementById("chartType").value.includes("Chart Constants"))
    {
        

        document.getElementById("chartTypeDisplay").innerHTML = document.getElementById("chartType").value
        if (document.getElementById("chartType").value == "14+ Chart Constants")
        {
            document.getElementById("chartTypeDisplay").innerHTML = "14+ ~ 15 Chart Constants"
        }

        var constantIndex = document.getElementById("chartType").value.split(" ")[0]
        var group = []

        for (var p = 0; p < constantGroups.length; p++)
        {
            if (constantGroups[p][0] == constantIndex)
            {   
                group = constantGroups[p][1]
                console.log(group)
            }
        }

        var contentsLoop = true

        var medalImages = ["", "medal_S.png", "medal_S+.png", "medal_SS.png", "medal_SS+.png", "medal_SSS.png", "medal_SSS+.png", "AP+.png", "AP.png", "FC+.png", "FC.png", "Clear.png","DX5.png","DX4.png","DX3.png","DX2.png","DX1.png"]  
        var totalRankData = [ 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  , 0  ]
                          //[ na , S  , S+ , SS , SS+, SSS,SSS+, AP+, AP , FC+, FC , C  , DX5, DX4, DX3, DX2, DX1]


        var groupContents = [[],[],[],[],[],[]]
        var groupContentsDate = [[],[],[],[],[],[]]

        while(contentsLoop)
        {
            for (var h = 0; h < group.length; h++)
            {
                if ( (parseFloat(data[counter][3]) == parseFloat(group[h]) && data[counter][11] != "utage") || data[counter][0] == "")
                {
                    groupContents[h].push(counter)
                    groupContentsDate[h].push(
                        parseInt(data[counter][12].split("-")[0]*365) + parseInt(data[counter][12].split("-")[1]*31) + parseInt(data[counter][12].split("-")[2])
                    )

                    //Rank data
                    if (data[counter][7] == "SSS+")
                    {
                        totalRankData[6]++
                    }
                    else if (data[counter][7] == "SSS")
                    {
                        totalRankData[5]++
                    }
                    else if (data[counter][7] == "SS+")
                    {
                        totalRankData[4]++
                    }
                    else if (data[counter][7] == "SS")
                    {
                        totalRankData[3]++
                    }
                    else if (data[counter][7] == "S+")
                    {
                        totalRankData[2]++
                    }
                    else if (data[counter][7] == "S")
                    {
                        totalRankData[1]++
                    }
                    else
                    {
                        totalRankData[0]++
                    }

                    //FC/AP data
                    if (data[counter][5] == "AP+")
                    {
                        totalRankData[7]++
                    }
                    else if (data[counter][5] == "AP")
                    {
                        totalRankData[8]++
                    }
                    else if (data[counter][5] == "FC+")
                    {
                        totalRankData[9]++
                    }
                    else if (data[counter][5] == "FC")
                    {
                        totalRankData[10]++
                    }
                    else
                    {
                        if (data[counter][7] != "-")
                        {
                            totalRankData[11]++
                        }
                    }

                    //DX☆ data
                    if (data[counter][6] > 0)
                    {
                        totalRankData[ 17 - parseInt(data[counter][6]) ]++ 
                    }


                    break
                }
            }
            counter++

            if (data[counter][0] == "")
            {
                counter=0
                contentsLoop = false
            }
        }

        console.log(totalRankData)


        var medalTransformList = [
        "",

        "380px, 0px",
        "320px, 0px", 
        "257.5px, 0px", 
        "185px, 0px", 
        "102.5px, 0px", 
        "20px, 0px",

        "470px, 0px",
        "535px, 0px",
        "600px, 0px",
        "665px, 0px",
        "730px, 0px",

        "470px, 30px",
        "535px, 30px",
        "600px, 30px",
        "665px, 30px",
        "730px, 30px",
        ]

        var medalTextTransformList = [
        "",

        "420px, 2px", 
        "365px, 2px", 
        "305px, 2px", 
        "235px, 2px",
        "155px, 2px",
        "75px, 2px",

        "500px, 2px",
        "565px, 2px",
        "630px, 2px",
        "695px, 2px",
        "760px, 2px",

        "500px, 32px",
        "565px, 32px",
        "630px, 32px",
        "695px, 32px",
        "760px, 32px",
        ]

        totalRankDataDisplay = document.createElement('div')
        totalRankDataDisplay.style.display = "grid"

            for (var q = totalRankData.length-1; q > 0; q--)
            {
                totalRankDataDisplay.style.height="32px"

                if (!DXstarToggled())
                {
                    if (q == totalRankData.length-1)
                    {
                        q=q-5
                    }
                }
                else
                {
                    if (FCAPToggled())
                    {
                        totalRankDataDisplay.style.height="62px"
                    }
                }

                if (!FCAPToggled() && q == totalRankData.length-6)
                {
                    q=q-5
                }


                img = document.createElement('img')
                img.classList.add('medalrecord')
                
                text = document.createElement('span')
                text.classList.add('medaltext')

                img.src = medalImages[q]
                text.innerHTML = totalRankData[q]

                if (DXstarToggled() && !FCAPToggled() && q > totalRankData.length-6 && q <= totalRankData.length-1)
                {
                    img.style.transform = "translate(" + medalTransformList[q-5] + ")"
                    text.style.transform = "translate(" + medalTextTransformList[q-5] + ")"
                }
                else
                {
                    img.style.transform = "translate(" + medalTransformList[q] + ")"
                    text.style.transform = "translate(" + medalTextTransformList[q] + ")"
                }   
                totalRankDataDisplay.appendChild(img)
                totalRankDataDisplay.appendChild(text)  
            }


        screen.appendChild(totalRankDataDisplay)

        var separator = document.createElement('div')
        separator.style.backgroundColor = "#e2e9f9"
        //separator.style.margin = "0px 0px 20px"
        separator.style.width = "100%"
        separator.style.height = "2px"
        separator.style.display = "block"
        screen.appendChild(separator)

        //sort by date
        var temp = 0
        for (var m = 0; m < groupContents.length; m++)
        {
            for (var r = 0; r < groupContents[m].length; r++)
            {
                for (var o = 0; o < groupContents[m].length-1; o++)
                {
                    if (groupContentsDate[m][o] > groupContentsDate[m][o+1])
                    {
                        temp = groupContentsDate[m][o]
                        groupContentsDate[m][o] = groupContentsDate[m][o+1]
                        groupContentsDate[m][o+1] = temp

                        temp = groupContents[m][o]
                        groupContents[m][o] = groupContents[m][o+1]
                        groupContents[m][o+1] = temp
                    }
                }
            }
        }

        var highestRank = 6
        /*
        0 na
        1 s
        2 s+
        3 ss
        4 ss+
        5 sss
        6 sss+
        */

        for (var i = 0; i < group.length; i++)
        {
            highestRank = 6

            var newRow = document.createElement('div')
            newRow.style.display = "flex"
            newRow.style.paddingTop = "20px"

            var rowHeader = document.createElement('div')
            rowHeader.classList.add('constantchartheader')
            //rowHeader.innerHTML = group[i]

                var headerContents = document.createElement('div')
                headerContents.style.display = "grid"
                headerContents.style.maxHeight = "47px"

                    var headerConstant = document.createElement('span')
                    headerConstant.classList.add('absoluteposition')
                    headerConstant.innerHTML = group[i]

                headerContents.appendChild(headerConstant)


            var chartContainer = document.createElement('div')
            chartContainer.classList.add('chartcontainer')
            chartContainer.style.marginBottom = "10px"
            chartContainer.style.marginTop = "10px"
            

            var chartRow_loop = true


            while(chartRow_loop)
            {
                var chartColumn = document.createElement('div')
                chartColumn.style.display = "flex"

                for (var p = 0; p < 8; p++)
                {   
                    if (counter < groupContents[i].length)
                    {

                        var newChart = document.createElement('div')
                        newChart.classList.add('constantchart')

                        if (data[groupContents[i][counter]][2] == "BASIC")
                        {
                            //newChart.style.backgroundColor = "rgb(46 189 99)"
                        }
                        else if (data[groupContents[i][counter]][2] == "ADVANCED")
                        {
                            //newChart.style.backgroundColor = "rgb(248 159 54)"
                        }
                        else if (data[groupContents[i][counter]][2] == "EXPERT")
                        {
                            //newChart.style.backgroundColor = "rgb(238 70 94)"
                        }
                        else if (data[groupContents[i][counter]][2] == "MASTER")
                        {
                            newChart.style.backgroundColor = "rgb(87 39 124)"
                        }
                        else if (data[groupContents[i][counter]][2] == "Re:MASTER")
                        {
                            newChart.style.backgroundColor = "rgb(122 93 120)"
                        }
                        else
                        {
                            newChart.style.backgroundColor = "transparent"
                        }

                        //image
                        img = document.createElement('img')
                        img.src = ("https://dp4p6x0xfi5o9.cloudfront.net/maimai/img/cover/" + data[ groupContents[i][counter] ][13])
                        img.style.transform = "translate(5px, 6px)"
                        img.style.height = "64px"
                        img.style.width = "64px"
                        img.classList.add('absoluteposition')

                        newChart.appendChild(img)

                        //border
                        img = document.createElement('img')
                        img.classList.add('absoluteposition')

                        if (data[groupContents[i][counter]][7] == "S" || data[groupContents[i][counter]][7] == "S+")
                        {
                            img.src = "border_silver.png"
                            img.style.transform = "translate(-3.3px, -1px)"
                            img.style.height = "78px"
                            img.style.width = "78px"

                            if (highestRank > 1 && data[groupContents[i][counter]][7] == "S")
                            {
                                highestRank = 1
                            }
                            else if (highestRank > 2 && data[groupContents[i][counter]][7] == "S+")
                            {
                                highestRank = 2
                            }
                        }
                        else if (data[groupContents[i][counter]][7] == "SS" || data[groupContents[i][counter]][7] == "SS+")
                        {
                            img.src = "border_gold.png"
                            img.style.transform = "translate(-1px, -0.5px)"
                            img.style.height = "76px"
                            img.style.width = "76px"

                            if (highestRank > 3 && data[groupContents[i][counter]][7] == "SS")
                            {
                                highestRank = 3
                            }
                            else if (highestRank > 4 && data[groupContents[i][counter]][7] == "SS+")
                            {
                                highestRank = 4
                            }
                        }
                        else if (data[groupContents[i][counter]][7] == "SSS" || data[groupContents[i][counter]][7] == "SSS+")
                        {
                            img.src = "border_rainbow.png"
                            img.style.transform = "translate(-1.4px, -2px)"
                            img.style.height = "79px"
                            img.style.width = "77px"

                            if (highestRank > 5 && data[groupContents[i][counter]][7] == "SSS")
                            {
                                highestRank = 5
                            }
                        }
                        else
                        {
                            highestRank = 0
                        }

                        newChart.appendChild(img)


                        //accuracy
                        text = document.createElement('span')
                        text.classList.add('absoluteposition')

                        text.innerHTML = truncateText(data[ groupContents[i][counter] ][4], 200, "16px Arial")
                        
                        text.style.transform = "translate(-1.5px, 79px)"
                        text.style.fontSize = "14px"
                        text.style.height = "15px"
                        text.style.textAlign = "center"
                        
                        newChart.appendChild(text)

                        //version
                        img = document.createElement('img')
                        if (data[ groupContents[i][counter] ][11] == "std")
                        {
                            img.src="https://dp4p6x0xfi5o9.cloudfront.net/maimai/img/type-std.png"
                            img.style.transform = "translate(0px, -13px)"
                        }
                        else
                        {
                            img.src="https://dp4p6x0xfi5o9.cloudfront.net/maimai/img/type-dx.png"
                            //img.style.transform = "translate(36px, -13px)"
                            img.style.transform = "translate(0px, -13px)"
                        }

                        img.classList.add('absoluteposition')
                        img.style.height =  "11px"

                        newChart.appendChild(img)


                        //plus
                        if (data[groupContents[i][counter]][7].includes("+"))
                        {
                            img = document.createElement('img')

                            img.src = "plus.png"
                            img.style.transform = "translate(57px, -10px)"
                            img.style.height = "30px"
                            img.style.width = "auto"

                            img.classList.add('absoluteposition')

                            newChart.appendChild(img)
                        }

                        //FC/AP
                        if (getComputedStyle(document.getElementById("FCAPToggle")).getPropertyValue("font-family") == "checked")
                        {
                            newChart.style.height = "130px"
                            img = document.createElement('img')
                            img.classList.add('absoluteposition')
                            if (data[groupContents[i][counter]][5] == "")
                            {
                                if (data[groupContents[i][counter]][4] != "")
                                {
                                    img.src = "Clear.png"
                                }
                            }
                            else
                            {
                                img.src = data[groupContents[i][counter]][5] + ".png"
                            }

                            img.style.width = "28px"


                            if (!DXstarToggled())
                            {
                                img.style.transform = "translate(23px, 97.5px)"
                            }
                            else
                            {
                                img.style.transform = "translate(39px, 97.5px)"
                            }
                            newChart.appendChild(img)
                        }

                        //DX☆
                        if (DXstarToggled() && parseInt(data[groupContents[i][counter]][6]) >= 0)
                        {
                            newChart.style.height = "130px"
                            img = document.createElement('img')
                            img.classList.add('absoluteposition')
                            img.src = "DX" + data[groupContents[i][counter]][6] + ".png"
                            img.style.width = "28px"

                            if (!FCAPToggled())
                            {
                                img.style.transform = "translate(23px, 97.5px)"
                            }
                            else
                            {
                                img.style.transform = "translate(6.5px, 97.5px)"
                            }
                            
                            newChart.appendChild(img)
                        }
        

                        if (data[counter][0] == "")
                        {
                            newChart.style.display = "none"
                        }

                        chartColumn.appendChild(newChart)

                        counter++
                    }
                }

                chartContainer.appendChild(chartColumn)

                if (counter >= groupContents[i].length)
                {
                    counter=0
                    chartRow_loop = false
                }
            }

            
            if (highestRank > 0)
            {
                headerRankMedal = document.createElement('img')
                headerRankMedal.classList.add('medal')
                headerRankMedal.src = medalImages[highestRank]

                headerRankMedal.style.transform = "translate(3px, -33px)"

                headerContents.appendChild(headerRankMedal)
            }   

            rowHeader.appendChild(headerContents)

            newRow.appendChild(rowHeader)

            newRow.appendChild(chartContainer)
            

            screen.appendChild(newRow)
            

            if (i != (group.length-1))
            {
                var separator = document.createElement('div')
                separator.style.backgroundColor = "#e2e9f9"
                //separator.style.margin = "0px 0px 20px"
                separator.style.width = "100%"
                separator.style.height = "2px"
                separator.style.display = "block"
                screen.appendChild(separator)
            }
        }

    }
    else
    {

        if (document.getElementById("chartType").value == "DX Rating")
        {
            /*
            var chartstext = document.createElement('span')
            chartstext.innerHTML = "⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ New Charts ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯"
            chartstext.style.margin = "20px 0px 10px 0px"
            chartstext.style.display = "block"
            chartstext.style.color = "#e99d9d"
            chartstext.classList.add('ChartsText')
            screen.appendChild(chartstext)
            */

            var chartstextimage = document.createElement('img')
            chartstextimage.src = "Newcharts_text.png"
            chartstextimage.style.margin = "20px 0px 10px 0px"
            chartstextimage.style.width = "100%"
            chartstextimage.style.display = "block"
            screen.appendChild(chartstextimage)
            document.getElementById("chartTypeDisplay").innerHTML = "DX Rating: " + data[3][14]
        }
        else
        {
            document.getElementById("chartTypeDisplay").innerHTML = document.getElementById("chartType").value
        }
        
        
        for (var i = 0; i < 10; i++)
        {

            var newRow = document.createElement('div')

            newRow.style.display = "flex"

            if (document.getElementById("chartType").value == "DX Rating")
            {
                if (i == 3)
                {
                    /*
                    var chartstext = document.createElement('span')
                    chartstext.innerHTML = "⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ Old Charts ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯"
                    chartstext.style.margin = "10px 0px 10px 0px"
                    chartstext.style.display = "block"
                    chartstext.style.color = "lightblue"
                    chartstext.classList.add('ChartsText')
                    screen.appendChild(chartstext)
                    */


                    var chartstextimage = document.createElement('img')
                    chartstextimage.src = "Oldcharts_text.png"
                    chartstextimage.style.width = "100%"
                    chartstextimage.style.margin = "12px 0px 10px 0px"
                    chartstextimage.style.display = "block"
                    screen.appendChild(chartstextimage)

                    counter=counter+2
                }
            }

            for (var p = 0; p < 5; p++)
            {

                var newChart = document.createElement('div')
                newChart.classList.add('chart')

                /*
                if (data[counter][1] == "\"411Ψ892\"")
                {
                    newChart.style.background = "linear-gradient( rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5) ), url(img/“411Ψ892”.png)"
                }
                else if (data[counter][1].startsWith("Sqlupp"))
                {
                    newChart.style.background = "linear-gradient( rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5) ), url(img/Sqlupp.png)" //I give up
                }
                else
                {
                    newChart.style.background = "linear-gradient( rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5) ), url(img/" + data[counter][1]
                    .replace(/ /g, "%20")
                    .replace(/\(/g, "%28")
                    .replace(/\)/g, "%29")
                    .replace(/'/g, '%27')
                    .replace(/:/g, '')
                    .replace(/#/g, '%23')
                    .replace(/\//g, '') 
                    + ".png)"
                }
                */

                newChart.style.background =  ("linear-gradient( rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5) ), url(https://dp4p6x0xfi5o9.cloudfront.net/maimai/img/cover/" + data[counter][9])
                newChart.style.backgroundSize = "cover"
                newChart.style.backgroundPosition = "center"
                
                var text = document.createElement('p')
                text.classList.add('absoluteposition')

                if (document.getElementById("chartType").value == "DX Rating" && counter > 16)
                {
                    text.innerHTML = "#" + (counter - 16)
                }
                else
                {
                    text.innerHTML = "#" + (counter + 1)
                }

                text.style.transform = "translate(5px, -6px)"
                text.style.fontSize = "11px"
                
                newChart.appendChild(text)

                if (!parseInt(data[counter][6]) > 0)
                {
                    newChart.style.background =  ("linear-gradient(rgb(0, 0, 0), rgb(0, 0, 0)")
                }
                else
                {
                    //title
                    text = document.createElement('p')
                    text.classList.add('absoluteposition')

                    text.innerHTML = truncateText(data[counter][1], 200, "16px Arial")

                    
                    text.style.transform = "translate(5px, 6px)"
                    text.style.fontSize = "11px"
                    
                    newChart.appendChild(text)


                    //type
                    //text = document.createElement('img')
                    text = document.createElement('p')
                    text.classList.add('absoluteposition')

                    if (data[counter][10] == "dx")
                    {
                        //text.src="https://dp4p6x0xfi5o9.cloudfront.net/maimai/img/type-std.png"
                        text.innerHTML="DX"
                    }
                    else
                    {
                        //text.src="https://dp4p6x0xfi5o9.cloudfront.net/maimai/img/type-dx.png"
                        text.innerHTML="STD"
                    }
                    
                    text.style.transform = "translate(5px, 20px)"
                    //text.style.width = "40px"
                    text.style.fontSize = "11px"
                    newChart.appendChild(text)


                    //accuracy
                    text = document.createElement('p')
                    text.classList.add('absoluteposition')

                    text.innerHTML = data[counter][4]
                    text.style.transform = "translate(4px, 48px)"
                    text.style.fontSize = "12px"
                    
                    newChart.appendChild(text)


                    //rank
                    text = document.createElement('p')
                    text.classList.add('absoluteposition')

                    text.innerHTML = data[counter][5]
                    text.style.transform = "translate(5px, 53px)"
                    text.style.fontSize = "20px"
                    
                    newChart.appendChild(text)


                    //internal diff
                    text = document.createElement('p')
                    text.classList.add('absoluteposition')

                    /*
                    for (var o = 0; o < songdata.split("\n").length; o++)
                    {
                        
                        if (data[counter][3] == songdata.split("\n")[o].split("\t")[2])
                        {
                            if (songdata.split("\n")[o].split("\t")[3] % 1 == 0)
                            {
                                text.innerHTML = songdata.split("\n")[o].split("\t")[3] + ".0"
                            }
                            else
                            {
                                text.innerHTML = songdata.split("\n")[o].split("\t")[3]
                            }
                            
                            console.log(songdata.split("\n")[o].split("\t")[3])
                            o=songdata.split("\n").length
                        }
                        

                    }
                    */

                    if (data[counter][3] % 1 == 0 && !(data[counter][3].includes(".0")))
                    {
                        text.innerHTML = data[counter][3] + ".0"
                    }
                    else
                    {
                        text.innerHTML = data[counter][3]
                    }

                    
                    text.style.transform = "translate(118px, 42px)"
                    text.style.fontSize = "13px"
                    
                    newChart.appendChild(text)


                    //Rating
                    text = document.createElement('p')
                    text.classList.add('absoluteposition')

                    text.innerHTML = data[counter][6]
                    text.style.transform = "translate(103px, 43px)"
                    text.style.fontSize = "26px"
                    totalrating = totalrating + parseInt(data[counter][6])

                    newChart.appendChild(text)


                    //Difficulty
                    text = document.createElement('div')
                    text.classList.add('absoluteposition')
                    text.classList.add('triangle')
                    if (data[counter][2] == "BASIC")
                    {
                        text.style.borderColor = "rgb(46 189 99) rgb(46 189 99) transparent transparent"
                    }
                    else if (data[counter][2] == "ADVANCED")
                    {
                        text.style.borderColor = "rgb(248 159 54) rgb(248 159 54) transparent transparent"
                    }
                    else if (data[counter][2] == "EXPERT")
                    {
                        text.style.borderColor = "rgb(238 70 94) rgb(238 70 94) transparent transparent"
                    }
                    else if (data[counter][2] == "MASTER")
                    {
                        text.style.borderColor = "rgb(124 54 177) rgb(124 54 177) transparent transparent"
                    }
                    else if (data[counter][2] == "Re:MASTER")
                    {
                        text.style.borderColor = "rgb(204 133 255) rgb(204 133 255) transparent transparent"
                    }
                    else
                    {
                        text.style.borderColor = "transparent transparent transparent transparent"
                    }

                    text.style.transform = "translate(118px, 0px)"
                    newChart.appendChild(text)


                    //FC/AP
                    if (getComputedStyle(document.getElementById("FCAPToggle")).getPropertyValue("font-family") == "checked")
                    {
                        text = document.createElement('img')
                        text.classList.add('absoluteposition')
                        if (data[counter][7] == "") 
                        {
                            text.src = "Clear.png"
                        }
                        else
                        {
                            text.src = data[counter][7] + ".png"
                        }

                        text.style.width = "22px"


                        if (!DXstarToggled())
                        {
                            text.style.transform = "translate(54px, 74px)"
                        }
                        else
                        {
                            text.style.transform = "translate(79px, 74px)"
                        }
                        newChart.appendChild(text)
                    }

                    //DX☆
                    if (DXstarToggled() && parseInt(data[counter][8]) >= 0)
                    {
                        text = document.createElement('img')
                        text.classList.add('absoluteposition')
                        text.src = "DX" + data[counter][8] + ".png"
                        text.style.width = "22px"
                        text.style.transform = "translate(54px, 74px)"
                        newChart.appendChild(text)
                    }   
                }

                


                newRow.appendChild(newChart)

                counter++
            }

            screen.appendChild(newRow)
        }
        setrating(totalrating)
    }
    
}

//generate()


var sheetId = "1wSngHJC9Sdimgz7N5SfqnG5N2-5BnxBhyvywem5uYiE";
//var type = "Best 50 Rating";
//Best 50 Rating
//DX Rating


const apiKey = "AIzaSyAr3rTUdyRPsO1yDtL9erI0QsvdALUMAxg";


async function fetchSheetAsTSV(range) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

  const res = await fetch(url);
  if (!res.ok)
  {
    alert("Failed to fetch sheet data")
  }


  const data = await res.json();

  // Fallback if no values
  if (!data.values || !Array.isArray(data.values)) return "";

  // Convert to TSV string
  return data.values
    .map(row => row.map(cell => (cell ?? "").replace(/\t/g, " ")).join("\t"))
    .join("\n");
}

async function fetchCredentials() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Credentials!B1:B2?key=${apiKey}`;

  const res = await fetch(url);
  if (!res.ok) throw new Error("Failed to fetch sheet data");

  const data = await res.json();

  return data
}


function FCAPToggled ()
{
    if (getComputedStyle(document.getElementById("FCAPToggle")).getPropertyValue("font-family") == "checked")
    {
        return true
    }
    else
    {
        return false
    }
}

function DXstarToggled ()
{
    if (getComputedStyle(document.getElementById("DXstarToggle")).getPropertyValue("font-family") == "checked")
    {
        return true
    }
    else
    {
        return false
    }
}



var cdata = []
var rawdata = []
var data = []
var tempratingdata=[]

async function loadtsvAsText(){

    if (document.getElementById("sheets_link").value == "")
    {
        alert("Please insert a valid Spreadsheet link / ID")
        return
    }

    for (var p = 0; p < document.getElementById("sheets_link").value.split("/").length; p++)
    {
        if (document.getElementById("sheets_link").value.split("/")[p] == "d")
        {
            sheetId = document.getElementById("sheets_link").value.split("/")[p+1]
            p=document.getElementById("sheets_link").value.split("/").length
        }
        else if (document.getElementById("sheets_link").value.split("/").length == 1 )
        {
            sheetId = document.getElementById("sheets_link").value.split("/")[0]
        }
    }
    
    
    cdata = await fetchSheetAsTSV("Credentials!B2:B5")
    console.log(cdata)

    if (cdata.split("\n")[3] != "")
    {
        document.getElementById("optionalImage").src=cdata.split("\n")[3]
        document.getElementById("optionalImage").style.display="block"
    }
    else
    {
        document.getElementById("optionalImage").style.display="none"
    }
    

    document.getElementById("pfp").src=cdata.split("\n")[1]
    document.getElementById("username").innerHTML=cdata.split("\n")[0]
    

    document.getElementById("login").style.display="none"
    document.getElementById("main").style.display="block"
    document.getElementById("back_save").style.display= "flex"

    if (document.getElementById("chartType").value.includes("Chart Constants"))
    {
        rawdata = await fetchSheetAsTSV("Master Table")
        tempratingdata = await fetchSheetAsTSV("Best 50 Rating!M2:M2")
        setrating(tempratingdata)
    }
    else
    {
        rawdata = await fetchSheetAsTSV(document.getElementById("chartType").value)
    }

    console.log(rawdata)
    data = (rawdata.split("\n"))

        for (var p = 0; p < data.length; p++)
        {
            data[p]=data[p].split("\t")
        }

        data.splice(0, 1)

        console.log(data)
        

        //sort()
        generate()
}



/*
function loadFileAsText(){
    var fileToLoad = document.getElementById("fileToLoad").files[0];

    var fileReader = new FileReader();


    fileReader.onload = function(fileLoadedEvent){
        var textFromFileLoaded = fileLoadedEvent.target.result;
        data = (textFromFileLoaded.split("\n"))

        for (var p = 0; p < data.length; p++)
        {
            data[p]=data[p].split("\t")
        }

        data.splice(0, 1)

        console.log(data)

        //try
        //{
            sort()
            generate()
        //}
        //catch(e)
        //{
        //    alert("something went wrong, did you upload the file properly?")
        //    console.log(e)
        //}

    };

    fileReader.readAsText(fileToLoad, "UTF-8");

}
*/



function sort ()
{
    var temp = ""

    for (var p = 0; p < data.length; p++)
    {
        if (isNaN(data[p][6]))
        {
            data[p][6] = 0
        }
    }

    for (var k = 0; k < data.length; k++)
    {
        for (var p = 1; p < data.length; p++)
        {
            if (data[p][6] > data[p-1][6])
            {
                temp = data[p]
                data[p] = data[p-1]
                data[p-1] = temp
            }
            else if (data[p][6] == data[p-1][6])
            {
                if (data[p][3] > data[p-1][3])
                {
                    temp = data[p]
                    data[p] = data[p-1]
                    data[p-1] = temp

                    if (data[p][4] > data[p-1][4])
                    {
                        temp = data[p]
                        data[p] = data[p-1]
                        data[p-1] = temp
                    }
                }
            }
        }
    }

}



function getfile ()
{
    $.get('/Maimai Chart Constants.tsv', function(filedata) {
        console.log(filedata)
    })
}


//do I really need chatgpt for this?

function truncateText(text, maxWidth, font) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      context.font = font;

      if (context.measureText(text).width <= maxWidth) {
        return text;
      }

      let truncated = '';
      const ellipsis = '…';
      for (let i = 0; i < text.length; i++) {
        truncated += text[i];
        if (context.measureText(truncated + ellipsis).width > maxWidth) {
          return truncated.slice(0, -1) + ellipsis;
        }
      }
      return truncated;
    }

function hideclass (x)
{
    document.querySelectorAll('.'+x).forEach(element => {
    element.style.display = 'none';
    }); 
}

function back ()
{
    document.getElementById("back_save").style.display= "none"
    document.getElementById("main").style.display= "none"
    document.getElementById("login").style.display= "block"
}


document.addEventListener("DOMContentLoaded", () => {
    const checkboxes = document.querySelectorAll(".checkbox");

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener("click", () => {
        checkbox.classList.toggle("checkbox_checked");
        checkbox.classList.toggle("checkbox_unchecked");
      });
    });
  });

function ismobile() {
    const toMatch = [
        /Android/i,
        /webOS/i,
        /iPhone/i,
        /iPad/i,
        /iPod/i,
        /BlackBerry/i,
        /Windows Phone/i
    ];
    
    return toMatch.some((toMatchItem) => {
        return navigator.userAgent.match(toMatchItem);
    });
}


function nthnumber(ntn, number){
    return Math.floor((number/Math.pow(10,ntn))%10);    
}


function setrating (rating)
{
    if (rating >= 15000)
    {
        document.getElementById("rating_border").src="border 15k.png"
    }
    else if (rating >=14500)
    {
        document.getElementById("rating_border").src="border 14.5k.png"
    }
    else if (rating >=14000)
    {
        document.getElementById("rating_border").src="border 14k.png"
    }
    else if (rating >=13000)
    {
        document.getElementById("rating_border").src="border 13k.png"
    }
    else if (rating >=12000)
    {
        document.getElementById("rating_border").src="border 12k.png"
    }
    else if (rating >=10000)
    {
        document.getElementById("rating_border").src="border 10k.png"
    }
    else
    {
        document.getElementById("rating_border").src="border 7k.png"
    }


    document.getElementById("ratingdigit1").src= "monospace" + nthnumber(4,rating) + ".png"
    document.getElementById("ratingdigit2").src= "monospace" + nthnumber(3,rating) + ".png"
    document.getElementById("ratingdigit3").src= "monospace" + nthnumber(2,rating) + ".png"
    document.getElementById("ratingdigit4").src= "monospace" + nthnumber(1,rating) + ".png"
    document.getElementById("ratingdigit5").src= "monospace" + nthnumber(0,rating) + ".png"
    document.getElementById("ratingDisplay").innerHTML = rating
}


document.getElementById("savebutton").addEventListener("click", tempmessage);


function tempmessage  ()
{
    if (document.getElementById("savebutton").style.display != "block")
    {
      alert("Please install the screenshot extension to use the 'Save Chart' feature using the link in the sheets.\nFor mobile users, you can screenshot the page")
    }
}

var urldata = []
var versionToDisplay = ""
function decodeDataFromUrl() {
    const hash = window.location.hash;
    const match = hash.match(/#data=(.+)/);
    if (match) {
      try {
        const decoded = decodeURIComponent(match[1]);
        urldata = decoded
        return (decoded)
      } catch (e) {
        console.error('Failed to decode data:', e);
      }
    }
    return false
}

window.addEventListener('load', async () => {
    try {
        
        if (decodeDataFromUrl() != false)
        {
            await getData("PRiSM PLUS")

            console.log(maimaiData)
            console.log(urldata)

            urldata=urldata.split(",")

            document.getElementById("optionalImage").style.display="none"
            document.getElementById("pfp").src=urldata[0]
            document.getElementById("username").innerHTML=urldata[1]

            //setrating(urldata[2])

            document.getElementById("login").style.display="none"
            document.getElementById("main").style.display="block"
            document.getElementById("back_save").style.display= "flex"

            document.getElementById("chartType").value = "DX Rating"

            urldata.splice(0, 2)

            for (var e = 0; e < 52; e++)
            {
                data.push([
                    "","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
                    ])
            }

            var num = 0
            var temptitle = "" 
            var tempaccuracy = ""
            var tempratingmultiplier = ""
            var tempdifficulty = "" 
            var temptype = ""


            for (var e = 0; e < urldata.length; e++)
            {


                num = Math.floor(e/4)

                if (e % 4 == 0)
                {
                    //title
                    data[num].splice(1,1,urldata[e]) 
                    temptitle = urldata[e]
                }
                else if (e % 4 == 1)
                {
                    //accuracy
                    data[num].splice(3,1,urldata[e])
                    tempaccuracy = urldata[e].split("%")[0]


                    if (num < 50)
                    {
                        
                        if (parseFloat(urldata[e].split("%")[0]) >= 100.5)
                        {
                            data[num].splice(4,1,"SSS+")
                            tempratingmultiplier = 22.4
                        }
                        else if (parseFloat(urldata[e].split("%")[0]) >= 100)
                        {
                            data[num].splice(4,1,"SSS")
                            tempratingmultiplier = 21.6
                        }
                        else if (parseFloat(urldata[e].split("%")[0]) >= 99.5)
                        {
                            data[num].splice(4,1,"SS+")
                            tempratingmultiplier = 21.1
                        }
                        else if (parseFloat(urldata[e].split("%")[0]) >= 99)
                        {
                            data[num].splice(4,1,"SS")
                            tempratingmultiplier = 20.8
                        }
                        else if (parseFloat(urldata[e].split("%")[0]) >= 98)
                        {
                            data[num].splice(4,1,"S+")
                            tempratingmultiplier = 20.3
                        }
                        else if (parseFloat(urldata[e].split("%")[0]) >= 97)
                        {
                            data[num].splice(4,1,"S")
                            tempratingmultiplier = 20
                        }
                    }


                }
                else if (e % 4 == 2)
                {
                    //difficulty
                    if (urldata[e] == "remaster")
                    {
                        data[num].splice(2,1,"Re:MASTER")
                    }
                    else
                    {
                        data[num].splice(2,1,urldata[e].toUpperCase())
                    }
                    tempdifficulty = urldata[e]
                }
                else if (e % 4 == 3)
                {
                    //type
                    data[num].splice(7,1,urldata[e])

                    if (urldata[e] == "standard")
                    {
                        temptype = 'std'
                    }
                    else
                    {
                        temptype = urldata[e]
                    }

                    


                    
                    for (var p = 0; p < maimaiData[0].length; p++)
                    {
                        /*
                        title      0
                        img        1
                        diff       2
                        type       3
                        constant   4
                        regionintl 5
                        regionovrd 6
                        versions   7
                        etc
                        */

                    
                        if (maimaiData[0][p] == temptitle && maimaiData[2][p] == tempdifficulty && maimaiData[3][p] == temptype)
                        {
                            
                            if (e == 3)
                            {
                                if (maimaiData[6][p] != null)
                                {
                                    await getData(maimaiData[6][p].toString())
                                    console.log("version = " + maimaiData[6][p])
                                    versionToDisplay = maimaiData[6][p].toString()
                                }
                                else
                                {
                                    await getData(maimaiData[7][p].toString())   
                                    console.log("version = " +  maimaiData[7][p])
                                    versionToDisplay = maimaiData[7][p].toString()
                                }
                            }
                            

                            data[num].splice(3,0,maimaiData[4][p].toString())
                            data[num].splice(8,0,(maimaiData[1][p] + ".png"))

                    
                            if (tempaccuracy > 100.5)
                            {
                                tempaccuracy = 100.5
                            }
                            data[num].splice(6,0, Math.floor(tempaccuracy/100 * tempratingmultiplier * maimaiData[4][p] ))
                        }

                        
                    }

                    
                }
            }

            data.splice(15,0,"","")
            data[3].splice(14,0,versionToDisplay)

            console.log(data)
            generate()
        }
    }
    catch (error) {
    console.error('Error during load:', error);
    }
})






//thanks ChatGPT, again
function extractMaimaiData(jsonData, version = "PRiSM PLUS") {



  const songIds = [];
  const imageNames = [];
  const difficulties = [];
  const types = [];
  const levelValues = [];
  const regionIntl = [];
  const regionOverrides = [];
  const versions = [];

  jsonData.songs.forEach(song => {
    song.sheets.forEach(sheet => {
      songIds.push(song.songId);
      imageNames.push(song.imageName);
      difficulties.push(sheet.difficulty);
      types.push(sheet.type);

      // Use multiverInternalLevelValue[version] if exists, fallback to internalLevelValue
      const versionValue = sheet.multiverInternalLevelValue?.[version];
      levelValues.push(versionValue ?? sheet.internalLevelValue);

      // Region intl availability
      regionIntl.push(sheet.regions.intl ?? false);

      // Region override for intl (null if not found)
      regionOverrides.push(sheet.regionOverrides?.intl.version ?? null);

      versions.push(sheet.version);
    });
  });

  return [
    songIds,
    imageNames,
    difficulties,
    types,
    levelValues,
    regionIntl,
    regionOverrides,
    versions
  ];
}


var maimaiJson = ""
var maimaiData = []
var tempversion = ""

async function getData(ver = "PRiSM PLUS") {
      const url = 'https://raw.githubusercontent.com/gekichumai/dxrating/refs/heads/main/packages/dxdata/dxdata.json'; // Replace with your actual JSON URL
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        maimaiJson = await response.json();
        //console.log(maimaiJson)

        const result = extractMaimaiData((maimaiJson), ver);

        maimaiData = result
        /*
        //version correction
        //idk if this even works
        for (var z = result[0].length; z > 0; z--)
        {

            if (result[5][z] == true)
            {
                if (result[6][z].version != undefined)
                {
                    console.log(result[6][z].version) //version override  
                    maimaiData = extractMaimaiData((maimaiJson), result[6][z].version)
                }
                else
                {
                    console.log(result[7][z]) //version  
                    console.log(result[0][z])
                    maimaiData = extractMaimaiData((maimaiJson), result[7][z])
                }
                z=0
            }
        }
        */   


      } catch (error) {
        console.error('Error fetching JSON:', error);
      }
    }

/*






//god why does CORS have to interfere again with the saving thing


/*
function save ()
{
    //alert("Unfortunately this isn't supported yet...Goddamnit CORS")
    captureScreenshot() 
}

function captureScreenshot() {
    const message = { type: "screenshot-div", selector: "#main" };

    try {
      chrome.runtime.sendMessage(message, (response) => {
        if (chrome.runtime.lastError) {
          console.warn("Extension not installed or not responding.");
          document.getElementById("extensionMessage").style.color = "red";
          document.getElementById("extensionMessage").innerText =
            "Screenshot extension not installed. Please install it to use this feature.";
        } else {
          console.log("Screenshot started:", response);
        }
      });
    } catch (err) {
        console.log(err)
      console.log("Not in a browser with extension support.");
    }
  }
*/


//loadtsvAsText()

</script>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</html> 
